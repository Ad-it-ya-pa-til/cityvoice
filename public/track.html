<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CityVoice • Track Your Complaint</title>
  <link rel="stylesheet" href="/index.css" />
  <link rel="stylesheet" href="/animations.css" />
  <script src="/darkmode.js"></script>
  <script src="/scroll-animations.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh}
    .track-wrap{max-width:1400px;margin:40px auto;padding:0 20px}
    .track-title{font-size:42px;font-weight:900;text-align:center;margin:0 0 12px;color:#1e293b;text-shadow:0 2px 4px rgba(0,0,0,0.05)}
    .track-subtitle{text-align:center;color:#64748b;font-size:18px;margin-bottom:40px}
    .track-card{background:#fff;border:none;border-radius:20px;padding:32px;box-shadow:0 8px 32px rgba(0,0,0,0.08);transition:all 0.3s ease}
    .track-card:hover{transform:translateY(-4px);box-shadow:0 16px 48px rgba(0,0,0,0.12)}
    .search-row{display:flex;gap:12px;margin-bottom:32px}
    .search-row input{flex:1;background:#f8fafc;color:#1e293b;border:2px solid #e2e8f0;border-radius:14px;padding:16px 20px;font-size:16px;font-weight:500;transition:all 0.3s ease}
    .search-row input:focus{outline:none;border-color:#3b82f6;background:#fff;box-shadow:0 0 0 4px rgba(59,130,246,0.1);transform:translateY(-2px)}
    .search-row input::placeholder{color:#94a3b8}
    .search-row button{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border:none;border-radius:14px;padding:16px 32px;font-weight:700;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(59,130,246,0.3)}
    .search-row button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,0.4)}
    .search-row button:active{transform:translateY(0)}
    .result{margin-top:16px}
    .result .head{display:flex;justify-content:space-between;align-items:center}
    .timeline{margin-top:12px;border-left:3px solid #e5e7eb;padding-left:12px}
    .titem{margin:8px 0}
    
    /* Enhanced Progress Bar */
    .progress-container{margin:12px 0;padding:16px;background:#f8fafc;border-radius:12px}
    .progress-label{font-size:14px;font-weight:700;color:#1e293b !important;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .progress-label::before{content:'';width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 2s ease-in-out infinite}
    .progress-bar{height:10px;background:#e2e8f0;border-radius:8px;overflow:hidden;position:relative}
    .progress-fill{height:100%;border-radius:8px;transition:width 0.8s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden}
    .progress-fill::after{content:'';position:absolute;top:0;left:0;bottom:0;right:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 2s infinite}
    .progress-fill.submitted{background:linear-gradient(135deg,#64748b 0%,#475569 100%);width:25%}
    .progress-fill.in-progress{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);width:50%}
    .progress-fill.under-review{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);width:75%}
    .progress-fill.resolved{background:linear-gradient(135deg,#10b981 0%,#059669 100%);width:100%}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    
    /* Enhanced Action Buttons */
    .action-buttons{display:flex;gap:10px;margin-top:12px}
    .action-btn{padding:8px 16px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.3s ease;position:relative;overflow:hidden}
    .action-btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,0.3);transform:translate(-50%,-50%);transition:width 0.6s,height 0.6s}
    .action-btn:active::before{width:300px;height:300px}
    .edit-btn{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,0.3)}
    .edit-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,0.4)}
    .delete-btn{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;box-shadow:0 2px 8px rgba(239,68,68,0.3)}
    .delete-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(239,68,68,0.4)}
    .view-btn{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;box-shadow:0 2px 8px rgba(16,185,129,0.3)}
    .view-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(16,185,129,0.4)}
    
    /* Enhanced Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);z-index:1000;animation:fadeIn 0.3s ease}
    .modal.active{display:flex;align-items:center;justify-content:center}
    .modal-content{background:#fff;border-radius:24px;padding:32px;max-width:560px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,0.3);animation:scaleIn 0.3s cubic-bezier(0.4,0,0.2,1)}
    .modal-header{margin-bottom:20px}
    .modal-title{font-size:24px;font-weight:800;color:#1e293b;margin:0}
    .modal-body{margin-bottom:20px}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:15px;font-weight:700;color:#1e293b;margin-bottom:8px}
    .form-input,.form-textarea{width:100%;padding:14px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:15px;font-family:inherit;transition:all 0.3s ease;background:#f8fafc}
    .form-input:hover,.form-textarea:hover{border-color:#cbd5e1}
    .form-input:focus,.form-textarea:focus{outline:none;border-color:#3b82f6;background:#fff;box-shadow:0 0 0 4px rgba(59,130,246,0.1);transform:translateY(-2px)}
    .form-textarea{min-height:120px;resize:vertical}
    .modal-footer{display:flex;gap:10px;justify-content:flex-end}
    .modal-btn{padding:14px 24px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.3s ease;position:relative;overflow:hidden}
    .modal-btn-primary{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;box-shadow:0 4px 12px rgba(59,130,246,0.3)}
    .modal-btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,0.4)}
    .modal-btn-secondary{background:#e2e8f0;color:#475569;font-weight:600}
    .modal-btn-secondary:hover{background:#cbd5e1;transform:translateY(-2px)}
    .modal-btn-danger{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;box-shadow:0 4px 12px rgba(239,68,68,0.3)}
    .modal-btn-danger:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(239,68,68,0.4)}
    
    /* Modern Card-Based Table */
    .table{width:100%;border-collapse:separate;border-spacing:0 12px}
    .table th{background:transparent;font-weight:700;color:#64748b;text-align:left;padding:0 16px 16px;border:none;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    .table td{padding:20px 16px;border:none;background:#fff;color:#1e293b;font-weight:500}
    .table tr{transition:all 0.3s ease}
    .table tbody tr{background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);cursor:pointer}
    .table tbody tr:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,0.12)}
    .table tbody tr td:first-child{border-radius:16px 0 0 16px}
    .table tbody tr td:last-child{border-radius:0 16px 16px 0}
    .complaint-row{position:relative}
    .complaint-row:hover .action-buttons{opacity:1}
    .action-buttons{opacity:0;transition:opacity 0.3s ease}
    
    /* Enhanced Toast */
    .toast{position:fixed;top:24px;right:24px;background:#1e293b;color:#fff;padding:16px 24px;border-radius:14px;z-index:2000;animation:slideInRight 0.4s cubic-bezier(0.4,0,0.2,1);box-shadow:0 12px 32px rgba(0,0,0,0.3);font-weight:600;display:flex;align-items:center;gap:12px;backdrop-filter:blur(10px)}
    .toast::before{content:'';width:8px;height:8px;border-radius:50%;background:currentColor}
    .toast.success{background:linear-gradient(135deg,#10b981 0%,#059669 100%);box-shadow:0 12px 32px rgba(16,185,129,0.4)}
    .toast.error{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);box-shadow:0 12px 32px rgba(239,68,68,0.4)}
    .toast.info{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);box-shadow:0 12px 32px rgba(59,130,246,0.4)}
    @keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    
    /* Empty State */
    .empty-state{text-align:center;padding:80px 20px}
    .empty-icon{font-size:80px;margin-bottom:24px;opacity:0.5}
    .empty-title{font-size:24px;font-weight:800;color:#1e293b;margin-bottom:12px}
    .empty-text{color:#64748b;font-size:16px;max-width:400px;margin:0 auto 32px}
    .empty-action{display:inline-block;padding:14px 28px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border-radius:12px;text-decoration:none;font-weight:700;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(59,130,246,0.3)}
    .empty-action:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,0.4)}
    
    /* Loading State */
    .loading-state{display:flex;justify-content:center;align-items:center;padding:60px 20px;flex-direction:column;gap:16px}
    .loading-spinner{width:48px;height:48px;border:4px solid #e2e8f0;border-top-color:#3b82f6;border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{color:#64748b;font-weight:600}
    
    /* Status Badge Enhanced */
    .badge{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;letter-spacing:0.3px;text-transform:uppercase}
    .badge-success{background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);color:#065f46;border:1.5px solid #86efac}
    .badge-info{background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);color:#1e40af;border:1.5px solid #93c5fd}
    .badge-neutral{background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);color:#475569;border:1.5px solid #cbd5e1}
    .badge-warning{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);color:#92400e;border:1.5px solid #fcd34d}
    
    /* Responsive */
    @media(max-width:768px){
      .track-title{font-size:32px}
      .search-row{flex-direction:column}
      .table{font-size:14px}
      .table th,.table td{padding:12px 10px}
      .action-buttons{opacity:1}
    }
    
    /* Dark Mode */
    [data-theme="dark"] body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%) !important}
    [data-theme="dark"] .track-title{color:var(--text) !important}
    [data-theme="dark"] .track-subtitle{color:#94a3b8}
    [data-theme="dark"] .track-card{background:var(--surface);border-color:var(--border)}
    [data-theme="dark"] .search-row input{background:#0b141e;border-color:var(--border);color:var(--text)}
    [data-theme="dark"] .modal-content{background:var(--surface)}
    [data-theme="dark"] .modal-title{color:var(--text)}
    [data-theme="dark"] .form-label{color:var(--text)}
    [data-theme="dark"] .form-input,[data-theme="dark"] .form-textarea{background:#0b141e;border-color:var(--border);color:var(--text)}
    [data-theme="dark"] .table th{background:#0f1b29;color:#94a3b8;border-bottom-color:var(--border)}
    [data-theme="dark"] .table td{border-bottom-color:var(--border);color:var(--text) !important;background:rgba(15,27,41,0.5)}
    [data-theme="dark"] .table tbody tr{background:rgba(15,27,41,0.5)}
    [data-theme="dark"] .table tbody tr:hover{background:rgba(15,27,41,0.8)}
    [data-theme="dark"] .progress-container{background:rgba(15,27,41,0.5)}
    [data-theme="dark"] .progress-label{color:var(--text) !important}
    [data-theme="dark"] .empty-title{color:var(--text)}
  </style>
</head>
<body class="dashboard">
  <header class="nav animate-slideInDown">
    <div class="container nav-inner">
      <div class="brand">
        <span class="logo">✴</span>
        <a class="brand-name" href="/" style="color:#dff1ff;text-decoration:none">CityVoice</a>
      </div>
      <nav class="menu">
        <a class="menu-link" href="/">Home</a>
        <a class="menu-link" href="/index.html#about">About</a>
        <a class="menu-link" href="/index.html#contact">Contact</a>
      </nav>
      <div class="actions">
        <a class="btn btn-primary" href="/complaint.html">Log a Complaint</a>
        <button class="btn btn-ghost" id="btn-logout" style="display:none">Logout</button>
      </div>
    </div>
  </header>

  <div class="track-wrap">
    <h1 class="track-title animate-fadeInUp">Track Your Complaints</h1>
    <p class="track-subtitle animate-fadeInUp delay-100">Search and manage your civic complaints with ease</p>
    <div class="track-card scroll-reveal delay-200">
      <div class="search-row">
        <input id="track-input" placeholder="🔍 Enter Complaint ID (e.g., CV-2025-003 or 3)" />
        <button id="track-btn" class="hover-lift">🔍 Search</button>
        <button id="reset-btn" class="modal-btn-secondary" style="width:auto;padding:16px 24px">🔄 Reset</button>
      </div>
      <p class="muted" id="table-desc">Overview of your submitted civic complaints. Click on a row for details.</p>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Complaint ID</th>
              <th>Title</th>
              <th>Category</th>
              <th>Date</th>
              <th class="right">Status</th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="rows-body"></tbody>
        </table>
      </div>
      <div id="rows-empty" class="muted" style="display:none;margin-top:8px">No complaints to show.</div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Complaint</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="edit-title">Title</label>
          <input type="text" id="edit-title" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label" for="edit-category">Category</label>
          <input type="text" id="edit-category" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label" for="edit-description">Description</label>
          <textarea id="edit-description" class="form-textarea"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label" for="edit-location">Location</label>
          <input type="text" id="edit-location" class="form-input">
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="saveComplaint()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Delete Complaint</h3>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this complaint? This action cannot be undone.</p>
        <p><strong id="delete-complaint-id"></strong></p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="modal-btn modal-btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    function badge(status){
      const cls = status === 'Resolved' ? 'badge-success' : status === 'In-Progress' ? 'badge-info' : 'badge-neutral';
      return `<span class="badge ${cls}">${status || 'Submitted'}</span>`;
    }
    function displayId(id){
      return `CV-${new Date().getFullYear()}-${String(id).padStart(3,'0')}`;
    }
    function getProgressClass(status){
      const statusLower = (status || '').toLowerCase();
      if (statusLower === 'resolved') return 'resolved';
      if (statusLower === 'in-progress' || statusLower === 'in progress') return 'in-progress';
      if (statusLower === 'under-review' || statusLower === 'under review') return 'under-review';
      return 'submitted';
    }
    function getProgressBar(status){
      const progressClass = getProgressClass(status);
      return `
        <div class="progress-container">
          <div class="progress-label">Progress: ${status || 'Submitted'}</div>
          <div class="progress-bar">
            <div class="progress-fill ${progressClass}"></div>
          </div>
        </div>
      `;
    }
    function parseInput(v){
      v = (v||'').trim();
      const m = v.match(/CV-\d{4}-(\d+)/i);
      if (m) return Number(m[1]);
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    async function fetchComplaint(id){
      const res = await fetch(`/api/complaints/${id}`);
      if (!res.ok) throw new Error('Not found');
      return res.json();
    }
    function renderTable(list){
      const tbody = document.getElementById('rows-body');
      const empty = document.getElementById('rows-empty');
      if (!list || !list.length){
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      tbody.innerHTML = list.map(c => {
        const dateStr = c.createdAt ? new Date(c.createdAt).toISOString().slice(0,10) : '';
        return `
          <tr class="complaint-row" data-id="${c.id}">
            <td>${displayId(c.id)}</td>
            <td><strong>${c.title || 'Untitled'}</strong></td>
            <td>${c.category || '—'}</td>
            <td class="muted">${dateStr}</td>
            <td class="right">
              ${badge(c.status)}
              ${getProgressBar(c.status)}
            </td>
            <td class="right">
              <div class="action-buttons">
                <button class="action-btn edit-btn" onclick="editComplaint(event, ${c.id})">✏️ Edit</button>
                <button class="action-btn delete-btn" onclick="deleteComplaint(event, ${c.id})">🗑️ Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      document.querySelectorAll('.complaint-row').forEach(tr => {
        tr.addEventListener('click', (e) => {
          if (!e.target.closest('.action-buttons')) {
            const id = tr.getAttribute('data-id');
            window.location.href = `/complaint_detail.html?id=${id}`;
          }
        });
      });
    }

    let myList = [];
    async function loadMine(){
      const token = localStorage.getItem('cv_token');
      if (!token){
        document.getElementById('rows-empty').textContent = 'Login to see your complaints or search by ID above.';
        document.getElementById('rows-empty').style.display = 'block';
        return;
      }
      try{
        const res = await fetch('/api/complaints?mine=1', { headers:{ 'x-auth-token': token }});
        myList = await res.json();
        renderTable(myList);
      }catch{
        document.getElementById('rows-empty').textContent = 'Unable to load your complaints.';
        document.getElementById('rows-empty').style.display = 'block';
      }
    }

    document.getElementById('track-btn').addEventListener('click', async () => {
      const v = document.getElementById('track-input').value;
      const id = parseInput(v);
      if (!id) { alert('Enter a valid Complaint ID'); return; }
      try{
        const c = await fetchComplaint(id);
        renderTable([c]);
        document.getElementById('table-desc').textContent = 'Search Result';
      }catch(err){
        renderTable([]);
        document.getElementById('rows-empty').textContent = 'Complaint not found.';
        document.getElementById('rows-empty').style.display = 'block';
      }
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      document.getElementById('track-input').value = '';
      document.getElementById('table-desc').textContent = 'Overview of your submitted civic complaints. Click on a row for details.';
      renderTable(myList);
    });

    // Modal and CRUD functions
    let currentEditId = null;
    let currentDeleteId = null;

    function editComplaint(event, id) {
      event.stopPropagation();
      event.preventDefault();
      currentEditId = id;
      const complaint = myList.find(c => c.id === id);
      if (complaint) {
        document.getElementById('edit-title').value = complaint.title || '';
        document.getElementById('edit-category').value = complaint.category || '';
        document.getElementById('edit-description').value = complaint.description || '';
        document.getElementById('edit-location').value = complaint.location || '';
        document.getElementById('edit-modal').classList.add('active');
        console.log('Edit modal opened for complaint:', id);
      } else {
        console.error('Complaint not found:', id);
        showToast('Complaint not found', 'error');
      }
    }

    function deleteComplaint(event, id) {
      event.stopPropagation();
      event.preventDefault();
      currentDeleteId = id;
      const complaint = myList.find(c => c.id === id);
      if (complaint) {
        document.getElementById('delete-complaint-id').textContent = displayId(id);
        document.getElementById('delete-modal').classList.add('active');
        console.log('Delete modal opened for complaint:', id);
      } else {
        console.error('Complaint not found:', id);
        showToast('Complaint not found', 'error');
      }
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('active');
      currentEditId = null;
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.remove('active');
      currentDeleteId = null;
    }

    async function saveComplaint() {
      if (!currentEditId) {
        console.error('No complaint selected for editing');
        return;
      }
      
      const token = localStorage.getItem('cv_token');
      if (!token) {
        showToast('❌ Please login to edit complaints', 'error');
        return;
      }

      const updatedData = {
        title: document.getElementById('edit-title').value.trim(),
        category: document.getElementById('edit-category').value,
        description: document.getElementById('edit-description').value.trim(),
        location: document.getElementById('edit-location').value.trim()
      };

      // Validate
      if (!updatedData.title) {
        showToast('❌ Title is required', 'error');
        return;
      }

      if (!updatedData.description) {
        showToast('❌ Description is required', 'error');
        return;
      }

      console.log('Updating complaint:', currentEditId, updatedData);

      try {
        const res = await fetch(`/api/complaints/${currentEditId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          },
          body: JSON.stringify(updatedData)
        });

        const data = await res.json();
        console.log('Update response:', data);

        if (res.ok) {
          showToast('✅ Complaint updated successfully!', 'success');
          closeEditModal();
          
          // Update the complaint in the list
          const index = myList.findIndex(c => c.id === currentEditId);
          if (index !== -1) {
            myList[index] = { ...myList[index], ...updatedData };
          }
          
          renderTable(myList); // Re-render immediately
          setTimeout(() => loadMine(), 500); // Reload from server
        } else {
          showToast(`❌ ${data.error || 'Failed to update complaint'}`, 'error');
        }
      } catch (error) {
        console.error('Error updating complaint:', error);
        showToast('❌ Network error. Please try again.', 'error');
      }
    }

    async function confirmDelete() {
      if (!currentDeleteId) {
        console.error('No complaint selected for deletion');
        return;
      }
      
      const token = localStorage.getItem('cv_token');
      if (!token) {
        showToast('❌ Please login to delete complaints', 'error');
        return;
      }

      console.log('Deleting complaint:', currentDeleteId);

      try {
        const res = await fetch(`/api/complaints/${currentDeleteId}`, {
          method: 'DELETE',
          headers: {
            'x-auth-token': token
          }
        });

        const data = await res.json();
        console.log('Delete response:', data);

        if (res.ok) {
          showToast('✅ Complaint deleted successfully!', 'success');
          closeDeleteModal();
          
          // Remove from local list immediately
          myList = myList.filter(c => c.id !== currentDeleteId);
          renderTable(myList); // Re-render immediately
          
          setTimeout(() => loadMine(), 500); // Reload from server
        } else {
          showToast(`❌ ${data.error || 'Failed to delete complaint'}`, 'error');
        }
      } catch (error) {
        console.error('Error deleting complaint:', error);
        showToast('❌ Network error. Please try again.', 'error');
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
        currentEditId = null;
        currentDeleteId = null;
      }
    });

    // Logout functionality
    const btnLogout = document.getElementById('btn-logout');
    const token = localStorage.getItem('cv_token');
    if (token && btnLogout) {
      btnLogout.style.display = 'inline-block';
      btnLogout.addEventListener('click', () => {
        localStorage.removeItem('cv_token');
        alert('Logged out successfully');
        window.location.href = '/';
      });
    }

    loadMine();
  </script>
</body>
</html>